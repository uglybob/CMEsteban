(function(b){b.removeDuplicate=function(b){if(b instanceof Array){var e=0;a:for(;e<b.length;e++)for(var c=0;c<b.length;c++)if(c!=e&&b[c]==b[e]){b=b.slice(c);continue a}return b}};b.extend(b.expr[":"],{inline:function(a){return b(a).is("a")||b(a).is("em")||b(a).is("i")||b(a).is("font")||b(a).is("span")||b(a).is("strong")||b(a).is("b")||b(a).is("u")}});var l=function(a,e){b.extend(this,{settings:e,createDOM:function(){this.textarea=a;this.container=document.createElement("div");this.iframe=document.createElement("iframe");
this.input=document.createElement("input");this.stylesheetLink=document.createElement("a");this.settings.stylesheet=b(this.stylesheetLink).attr({href:this.settings.stylesheet})[0].href;b(this.input).attr({type:"hidden",name:b(this.textarea).attr("name"),value:b(this.textarea).attr("value")});b(this.textarea).addClass("depageEditorTextarea");b(this.textarea).attr("name",b(this.textarea).attr("name")+"depageEditorTextarea");b(this.textarea).hide();b(this.container).addClass(e.containerClass);b(this.iframe).addClass("depageEditorIframe");
this.toolbar=new k(this);b(this.container).append(this.toolbar.itemsList);b(this.container).append(this.iframe);b(this.container).append(this.input);b(this.container).hide();this.input.depageEditorObject=this;b(this.textarea).replaceWith(this.container)},writeDocument:function(){var c='                    <html>                        <head>                            <link rel="stylesheet" type="text/css" href="'+e.stylesheet+'"></link>                        </head>                        <body id="iframeBody">                            '+
b(this.input).val()+"                        </body>                    </html>                ",c=c.replace(/INSERT:CONTENT:END/,b(this.input).val());this.iframe.contentWindow.document.open();this.iframe.contentWindow.document.write(c);this.iframe.contentWindow.document.close();var d=this;b(this.iframe).load(function(){d.autogrow()})},makeEditable:function(){var c=this;try{this.iframe.contentWindow.document.designMode="on"}catch(d){return setTimeout(function(){c.makeEditable()},250),!1}b(this.container).show();
b(this.textarea).show();b(this.iframe.contentWindow.document).mouseup(function(){c.toolbar.checkState(c);c.autogrow()}).keyup(function(){c.toolbar.checkState(c);c.autogrow()}).keydown(function(b){c.detectPaste(b);c.autogrow()}).scroll(function(){c.autogrow()});this.locked=!1},focusEditor:function(){b.browser.msie||this.iframe.focus()},styleWithCSS:function(){try{this.iframe.contentWindow.document.execCommand("styleWithCSS",!1,!1)}catch(b){try{this.iframe.contentWindow.document.execCommand("useCSS",
0,!0)}catch(d){}}},modifyFormSubmit:function(){var c=this;b(this.container).parents("form").submit(function(){return c.updateDepageEditorInput()})},insertNewParagraph:function(c,d){var a=b(this.iframe).contents().find("body"),e=this.iframe.contentWindow.document.createElement("p");b(c).each(function(){b(e).append(this)});a.append(e)},paragraphise:function(){if(e.insertParagraphs&&this.wysiwyg){var c=b(this.iframe).contents().find("body").contents();c.each(function(){"#text"==this.nodeName.toLowerCase()&&
-1!=this.data.search(/^\s*$/)&&(this.data="")});var d=this,a=[];c.each(function(){if(b(this).is(":inline")||3==this.nodeType)a.push(this),b(this).remove();else if(b(this).is("br")){if(!b(this).is(":last-child"))if(b(this).next().is("br")){for(;b(this).next().is("br");)b(this).remove();a.length&&(d.insertNewParagraph(a,this),a=[])}else(b(this).is(":inline")||3==this.nodeType)&&a.length&&a.push(this.cloneNode(!0)),b(this).remove()}else a.length&&(d.insertNewParagraph(a,this),a=[])});0<a.length&&this.insertNewParagraph(a)}},
switchMode:function(){this.locked||(this.locked=!0,this.wysiwyg?(this.updateDepageEditorInput(),b(this.textarea).val(b(this.input).val()),b(this.iframe).replaceWith(this.textarea),this.toolbar.disable(),this.locked=this.wysiwyg=!1):(this.updateDepageEditorInput(),b(this.textarea).replaceWith(this.iframe),this.writeDocument(this.input.value),this.toolbar.enable(),this.makeEditable(),this.wysiwyg=!0))},detectPaste:function(c){if(c.ctrlKey&&86==c.keyCode&&!this.cleaning){var a=this;setTimeout(function(b){a.cleanSource()},
100)}if(13==c.keyCode){for(c=this.getSelection().parentnode;3==c[0].nodeType||c.is(":inline");)c=c.parent();c=c[0].nodeName.toLowerCase();if("body"==c||"div"==c)c=b.browser.msie?"<p>":"p",this.styleWithCSS(),this.iframe.contentWindow.document.execCommand("FormatBlock",!1,c)}},cleanSource:function(){this.cleaning=!0;var c="",c=b(this.iframe.contentWindow.document).find("body");c.find("*").each(function(){var c=this.nodeName.toLowerCase();if(-1===b.inArray(c,e.allowedTags))if("remove"==e.undesiredTags[c])b(this).remove();
else{var a=b(this);if("body"==a.parent()[0].tagName.toLowerCase()&&this.firstChild&&(b(this.firstChild).is(":inline")||3==this.firstChild.nodeType)){var g=b("<p></p>").insertBefore(a);a.contents().each(function(){g.append(this)})}else a.contents().each(function(){a.before(this)});a.remove()}});c=this.wysiwyg?c.html():b(this.textarea).val();c=c.replace(/^\s*/,"");c=c.replace(/\s*$/,"");c=c.replace(/<--.*--\x3e/,"");c=c.replace(/<[^>]*>/g,function(c){c=c.replace(/='(.*)' /g,'="$1" ');c=c.replace(/ ([^=]+)="?([^"]*)"?/g,
function(c,a,d){if(-1==b.inArray(a,e.allowedAttributes))return"";switch(a){case "id":if(-1==b.inArray(d,e.allowedIDs))return"";case "class":if(-1==b.inArray(d,e.allowedClasses))return"";default:return c}});return c.toLowerCase()});c=c.replace(/ style="[^"]*"/g,"");c=c.replace(/<br>/g,"<br />");c=c.replace(/<br \/>\s*<\/(h1|h2|h3|h4|h5|h6|li|p)/g,"</$1");c=c.replace(/(<br \/>)*\s*(<\/[^>]*>)/g,"$2$1");c=c.replace(/(<img [^>]+[^\/])>/g,"$1 />");c=c.replace(/(<[^\/]>|<[^\/][^>]*[^\/]>)\s*<\/[^>]*>/g,
"");c=c.replace(/<\?xml[^>]*>/g,"");c=c.replace(/<[^ >]+:[^>]*>/g,"");c=c.replace(/<\/[^ >]+:[^>]*>/g,"");c=c.replace(/\n/g,"");c=c.replace(/(<\/(p|h1|h2|li|ul|ol)>)/g,"$1\n");this.wysiwyg?b(this.iframe.contentWindow.document).find("body").html(c):b(this.textarea).val(c);b(this.input).val(c);this.cleaning=!1},refreshDisplay:function(){this.wysiwyg?b(this.iframe.contentWindow.document).find("body").html(b(this.input).val()):b(this.textarea).val(b(this.input).val())},autogrow:function(){if(!1!=this.settings.autogrow&&
this.wysiwyg){var c=b(this.iframe.contentWindow.document.body),a=b(this.toolbar.itemsList),e=0;void 0!=c[0]&&(e=Math.max(0,b(window).scrollTop()-b(this.iframe).offset().top),e=Math.min(e,b(this.iframe).height()-a.height()),a.css({top:e}),e=c.children(":last"),e=0<e.length?e.offset().top+e.height()+30-b(window).scrollTop():c.offsetHeight+30,e=Math.max(e,a.height()),c.css({overflow:"hidden",scroll:"no"}),b(this.iframe).height(e),b(this.textarea).height(e))}},updateDepageEditorInput:function(){this.wysiwyg?
(this.paragraphise(),this.cleanSource()):b(this.input).val(b(this.textarea).val())},getSelection:function(){var c=null,a=null,e=null;if(this.iframe.contentWindow.document.selection){c=this.iframe.contentWindow.document.selection;a=c.createRange();try{e=b(a.parentElement())}catch(g){return!1}}else{try{c=this.iframe.contentWindow.getSelection()}catch(h){return!1}a=c.getRangeAt(0);e=b(a.commonAncestorContainer)}return{range:a,parentnode:e}},init:function(c){var a=this;if("string"==typeof document.designMode||
"off"==document.designMode)a.locked=!0,a.cleaning=!1,a.DOMCache="",a.wysiwyg=!0,a.createDOM(),a.writeDocument(),a.makeEditable(),a.modifyFormSubmit(),a.autogrow(),b(window).scroll(function(){a.autogrow()})}});this.init()},k=function(a){b.extend(this,{createDOM:function(){var a=this;this.itemsList=document.createElement("ul");b(this.itemsList).addClass("depageEditorToolbar");b.each(this.depageEditor.settings.toolbarItems,function(b,d){"formatblock"==d?a.addSelect(d):a.addButton(d)})},addButton:function(a){var c=
b.depageEditorToolbarItems[a],d=b(document.createElement("li"));a="undefined"!=typeof this.depageEditor.settings.translation[a]?this.depageEditor.settings.translation[a]:c.label;var f=b(document.createElement("a")).attr({title:a,"class":c.className,href:"#"+a}).click(function(){return!1});c.editor=this.depageEditor;b(f).data("action",c);b(f).data("editor",this.depageEditor);f.bind("click",c.action);f.append(document.createTextNode(a));d.append(f);b(this.itemsList).append(d)},addSelect:function(a){var c=
this,d=b.depageEditorToolbarItems[a],f=b(document.createElement("li")).attr("class","depageEditorEditSelect"),g=b(document.createElement("select")).attr({name:d.name,"class":d.className});b(g).data("editor",this.depageEditor);b(g).change(d.action);var h=b(document.createElement("option"));h.append(document.createTextNode("undefined"!=typeof this.depageEditor.settings.translation[a]?this.depageEditor.settings.translation[a]:d.label));g.append(h);b.each(this.depageEditor.settings.selectBlockOptions,
function(a,e){var d=b(document.createElement("option")).attr("value",e);d.append(document.createTextNode(c.depageEditor.settings.translation[e]));g.append(d)});f.append(g);b(this.itemsList).append(f)},disable:function(){b(this.itemsList).toggleClass("depageEditorSource");b(this.itemsList).find("li select").attr("disabled","disabled")},enable:function(){b(this.itemsList).toggleClass("depageEditorSource");b(this.itemsList).find("select").removeAttr("disabled")},checkState:function(a,c){if(!c)return setTimeout(function(){a.toolbar.checkState(a,
!0);return!0},200),!0;b(a.toolbar.itemsList).find("a").removeClass("on");for(var d=a.getSelection().parentnode;3==d[0].nodeType;)d=d.parent();for(;!d.is("body");)d.is("a")?a.toolbar.setState("link","on"):d.is("em")||d.is("i")?a.toolbar.setState("italic","on"):d.is("strong")||d.is("b")?a.toolbar.setState("bold","on"):d.is("span")||d.is("p")?("italic"==d.css("font-style")&&a.toolbar.setState("italic","on"),"bold"==d.css("font-weight")&&a.toolbar.setState("bold","on")):d.is("ol")?(a.toolbar.setState("orderedlist",
"on"),a.toolbar.setState("unorderedlist","off")):d.is("ul")?(a.toolbar.setState("orderedlist","on"),a.toolbar.setState("unorderedlist","off")):a.toolbar.setState("formatblock",d[0].nodeName.toLowerCase()),d=d.parent()},setState:function(a,c){"SelectBlock"!=a?b(this.itemsList).find("."+b.depageEditorToolbarItems[a].className).addClass("on"):b(this.itemsList).find("."+b.depageEditorToolbarItems[a].className).val(c)},init:function(a){this.depageEditor=a;this.createDOM()}});this.init(a)};b.depageEditorToolbarItems=
new function(){depageEditorToolbarItemsClass=this.constructor;if("undefined"!=typeof depageEditorToolbarItemsClass.singleton)return depageEditorToolbarItemsClass.singleton;depageEditorToolbarItemsClass.singleton=this;b.extend(depageEditorToolbarItemsClass.singleton,{bold:{className:"depageEditorButtonBold",action:function(){var a=b.data(this,"editor");a.wysiwyg&&(a.styleWithCSS(),a.iframe.contentWindow.document.execCommand("bold",!1,null),a.toolbar.setState("bold","on"),a.focusEditor())}},italic:{className:"depageEditorButtonItalic",
action:function(){var a=b.data(this,"editor");a.wysiwyg&&(a.styleWithCSS(),a.iframe.contentWindow.document.execCommand("italic",!1,null),a.toolbar.setState("italic","on"),a.focusEditor())}},link:{className:"depageEditorButtonHyperlink",action:function(){var a=b.data(this,"editor");if(a.wysiwyg)if(b(this).hasClass("on"))a.styleWithCSS(),a.iframe.contentWindow.document.execCommand("Unlink",!1,null),a.focusEditor();else if(""==b(a.iframe).getSelection())alert(a.settings.translation.selectTextToHyperlink),
a.focusEditor();else{var e=prompt(a.settings.translation.linkURL,"http://");null!=e&&(a.styleWithCSS(),a.iframe.contentWindow.document.execCommand("CreateLink",!1,e),a.toolbar.setState("link","on"),a.focusEditor())}}},orderedlist:{className:"depageEditorButtonOrderedList",action:function(){var a=b.data(this,"editor");a.wysiwyg&&(a.styleWithCSS(),a.iframe.contentWindow.document.execCommand("insertorderedlist",!1,null),a.toolbar.setState("orderedlist","on"),a.focusEditor())}},unorderedlist:{className:"depageEditorButtonUnorderedList",
action:function(){var a=b.data(this,"editor");a.wysiwyg&&(a.styleWithCSS(),a.iframe.contentWindow.document.execCommand("insertunorderedlist",!1,null),a.toolbar.setState("unorderedlist","on"),a.focusEditor())}},image:{className:"depageEditorButtonImage",action:function(){var a=b.data(this,"editor");if(a.wysiwyg){var e=prompt(a.settings.translation.imageLocation,"");if(null!=e&&""!=e){var c=prompt(a.settings.translation.imageAlternateText,""),c=c.replace(/"/g,"'");b(a.iframe).appendToSelection("img",
{src:e,alt:c},null,!0)}a.focusEditor()}}},htmlsource:{className:"depageEditorButtonHTML",action:function(){b.data(this,"editor").switchMode()}},formatblock:{className:"depageEditorSelectformatblock",action:function(){var a=b.data(this,"editor");if(a.wysiwyg){var e=b.browser.msie?"<"+b(this).val()+">":b(this).val();a.styleWithCSS();a.iframe.contentWindow.document.execCommand("FormatBlock",!1,e);a.focusEditor()}}}})};b.fn.extend({getSelection:function(){if(this.is("iframe"))return iframe=this[0],iframe.contentWindow.document.selection?
iframe.contentWindow.document.selection.createRange().text:iframe.contentWindow.getSelection().toString()},appendToSelection:function(a,e,c,d){if(this.is("iframe"))if(iframe=this[0],b.browser.msie){var f;f="<"+a;b.each(e,function(a,b){f+=" "+a+'="'+b+'"'});d?f+=" />":(f+=">",c&&"undefined"!=typeof c&&(f+=c),f+="</"+a+">");d=iframe.contentWindow.document.selection;d=d.createRange();b(d.parentElement()).parents("body").is("#iframeBody ")||(d.collapse(!1),d.pasteHTML(f))}else d=iframe.contentWindow.getSelection(),
d=d.getRangeAt(0),d.collapse(!1),a=iframe.contentWindow.document.createElement(a),b(a).attr(e),c&&"undefined"!=typeof c&&b(a).append(document.createTextNode(c)),d.insertNode(a)},depageEditor:function(a){var e={script:"remove",meta:"remove",link:"remove",basefont:"remove",object:"remove",applet:"remove",input:"remove",select:"remove",textarea:"remove",button:"remove",isindex:"remove",area:"remove",frame:"remove",frameset:"remove",noframes:"remove",iframe:"remove"},c="class id href title alt src".split(" ");
a=b.extend({insertParagraphs:!0,stylesheet:"depageEditorContent.css",toolbarItems:"bold italic link orderedlist unorderedlist htmlsource formatblock".split(" "),selectBlockOptions:"h1 h2 h3 h4 h5 h6 p".split(" "),undesiredTags:e,allowedTags:"p h1 h2 ul ol li a b strong i em".split(" "),allowedClasses:[],allowedIDs:[],allowedAttributes:c,containerClass:"depageEditor",translation:{bold:"Bold",italic:"Italic",link:"Hyperlink",unorderedlist:"Unordered List",orderedlist:"Ordered List",image:"Insert image",
htmlsource:"HTML Source",formatblock:"Change Block Type",h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6",p:"Paragraph",selectTextToHyperlink:"Please select the text you wish to hyperlink.",linkURL:"Enter the URL for this link:",imageLocation:"Enter the location for this image:",imageAlternateText:"Enter the alternate text for this image:"},autogrow:!1},a);for(var d=a.selectBlockOptions.length-1;0<=d;d--)-1===b.inArray(a.selectBlockOptions[d],a.allowedTags)&&
a.selectBlockOptions.splice(d,1);a.undesiredTags=a.undesiredTags.length!=e.length?b.removeDuplicate(b.merge(a.undesiredTags,e)):a.undesiredTags;a.allowedAttributes=a.allowedAttributes.length!=c.length?b.removeDuplicate(b.merge(a.allowedAttributes,c)):a.allowedAttributes;return this.each(function(){new l(this,a)})}})})(jQuery);
